<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MastoDiff - Deep Linkable History</title>
    <style>
      :root {
        --bg: #0d1117;
        --card-bg: #161b22;
        --text: #e6edf3;
        --border: #30363d;
        --add-bg: #2ea44f26;
        --add-line: #3fb950;
        --del-bg: #da363326;
        --del-line: #f85149;
      }
      body {
        font-family: -apple-system, sans-serif;
        background: var(--bg);
        color: var(--text);
        padding: 20px;
        margin: 0;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
      }

      /* Sticky Header */
      .input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        position: sticky;
        top: 0;
        background: var(--bg);
        padding: 15px 0;
        z-index: 100;
        border-bottom: 1px solid var(--border);
      }
      input {
        flex: 1;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: var(--card-bg);
        color: white;
        font-size: 14px;
      }
      button {
        padding: 10px 20px;
        border-radius: 6px;
        border: none;
        background: #238636;
        color: white;
        cursor: pointer;
        font-weight: bold;
      }
      button.secondary {
        background: #30363d;
        border: 1px solid var(--border);
      }

      .revision-card {
        border: 1px solid var(--border);
        border-radius: 6px;
        margin-bottom: 40px;
        background: var(--card-bg);
        overflow: hidden;
      }
      .revision-header {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border);
        font-size: 0.9em;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #1f242c;
      }
      .ver-badge {
        background: #388bfd3d;
        color: #79c0ff;
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: bold;
        border: 1px solid #388bfd66;
      }

      /* Scrollable Diff View */
      .diff-wrapper {
        overflow-x: auto;
        width: 100%;
        background: #010409;
      }
      .diff-table {
        width: 100%;
        border-collapse: collapse;
        font-family: "SFMono-Regular", Consolas, monospace;
        font-size: 13px;
        min-width: 650px;
      }
      .diff-line {
        display: flex;
        width: 100%;
        border-left: 4px solid transparent;
      }
      .diff-line.addition {
        background-color: var(--add-bg);
        border-left-color: var(--add-line);
      }
      .diff-line.deletion {
        background-color: var(--del-bg);
        border-left-color: var(--del-line);
      }
      .line-num {
        width: 50px;
        text-align: right;
        padding-right: 15px;
        color: #484f58;
        user-select: none;
        border-right: 1px solid var(--border);
        flex-shrink: 0;
      }
      .line-content {
        padding: 2px 10px;
        white-space: pre;
        word-wrap: normal;
        flex-grow: 1;
      }

      /* Metadata / CW styling */
      .metadata-diff {
        padding: 10px 15px;
        background: #1c2128;
        border-bottom: 1px solid var(--border);
        font-size: 13px;
      }
      .cw-label {
        color: #f0883e;
        font-weight: bold;
        margin-right: 8px;
      }

      /* Media */
      .media-diff {
        padding: 15px;
        border-top: 1px solid var(--border);
        background: #0d1117;
      }
      .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 10px;
      }
      .media-item {
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 8px;
        background: var(--card-bg);
      }
      .media-item img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 4px;
      }
      .alt-text {
        font-size: 12px;
        margin-top: 8px;
      }
      .alt-changed {
        color: #e3b341;
        border-top: 1px dashed #443d2c;
        margin-top: 5px;
        padding-top: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div
        style="
          display: flex;
          align-items: center;
          justify-content: space-between;
        "
      >
        <h2>üêò MastoDiff</h2>
        <button
          id="copyBtn"
          class="secondary"
          style="display: none"
          onclick="copyDeepLink()"
        >
          Copy Shareable Link
        </button>
      </div>

      <div class="input-group">
        <input
          type="text"
          id="urlInput"
          placeholder="Paste Mastodon post URL (e.g. https://mastodon.social/@user/123...)"
        />
        <button onclick="handleFetchClick()">Compare Versions</button>
      </div>
      <div id="output"></div>
    </div>

    <script>
      // 1. Listen for page load and hash changes for deep linking
      window.addEventListener("load", checkHash);
      window.addEventListener("hashchange", checkHash);

      function checkHash() {
        const hash = window.location.hash.substring(1);
        if (hash && hash.startsWith("http")) {
          document.getElementById("urlInput").value = hash;
          fetchHistory(hash);
        }
      }

      function handleFetchClick() {
        const url = document.getElementById("urlInput").value.trim();
        if (url) {
          window.location.hash = url; // This triggers hashchange -> fetchHistory
        }
      }

      function copyDeepLink() {
        navigator.clipboard.writeText(window.location.href);
        const btn = document.getElementById("copyBtn");
        btn.textContent = "Copied!";
        setTimeout(() => (btn.textContent = "Copy Shareable Link"), 2000);
      }

      async function fetchHistory(urlInput) {
        const output = document.getElementById("output");
        output.innerHTML = "<p>Crunching history data...</p>";
        document.getElementById("copyBtn").style.display = "block";

        try {
          const url = new URL(urlInput);
          const id = url.pathname.split("/").filter(Boolean).pop();
          const apiBase = `https://${url.hostname}/api/v1/statuses/${id}/history`;

          const response = await fetch(apiBase);
          if (!response.ok)
            throw new Error(
              "Could not access API. Check if the post is private or the instance blocks public API access.",
            );
          const history = await response.json();

          renderAllDiffs(history);
        } catch (e) {
          output.innerHTML = `<p style="color:var(--del-line)"><b>Error:</b> ${e.message}</p>`;
        }
      }

      function renderAllDiffs(history) {
        const output = document.getElementById("output");
        output.innerHTML = "";

        for (let i = history.length - 1; i >= 0; i--) {
          const current = history[i];
          const previous = i > 0 ? history[i - 1] : null;

          const card = document.createElement("div");
          card.className = "revision-card";

          const date = new Date(current.created_at).toLocaleString();
          const versionLabel = i === 0 ? "Original Post" : `Revision ${i}`;

          // Check for CW/Spoiler Text changes
          let metadataHtml = "";
          const cwChanged =
            previous && current.spoiler_text !== previous.spoiler_text;
          if (current.spoiler_text || cwChanged) {
            metadataHtml = `
                    <div class="metadata-diff">
                        <span class="cw-label">CW:</span> 
                        <span>${escapeHtml(current.spoiler_text || "(Removed)")}</span>
                        ${cwChanged ? `<div style="color:#8b949e; font-size:11px;">Was: ${escapeHtml(previous.spoiler_text || "(None)")}</div>` : ""}
                    </div>`;
          }

          const diffContent =
            i === 0
              ? generateDiffHtml("", current.content, true)
              : generateDiffHtml(previous.content, current.content);

          card.innerHTML = `
                <div class="revision-header">
                    <span class="ver-badge">${versionLabel}</span>
                    <span style="color: #8b949e">${date}</span>
                </div>
                ${metadataHtml}
                <div class="diff-wrapper">
                    <table class="diff-table">${diffContent}</table>
                </div>
                ${generateMediaDiffHtml(previous ? previous.media_attachments : [], current.media_attachments)}
            `;
          output.appendChild(card);
        }
      }

      function generateDiffHtml(oldHtml, newHtml, isInitial = false) {
        const clean = (h) =>
          h
            .replace(/<br\s*\/?>/gi, "\n")
            .replace(/<\/p><p>/gi, "\n\n")
            .replace(/<[^>]+>/g, "")
            .trim();
        const oldLines = isInitial ? [] : clean(oldHtml).split("\n");
        const newLines = clean(newHtml).split("\n");

        let html = "";
        let i = 0,
          j = 0;
        let lineCounter = 1;

        if (isInitial) {
          newLines.forEach((line, idx) => {
            html += renderRow(idx + 1, "+", line, "addition");
          });
        } else {
          // Basic line-by-line comparison
          while (i < oldLines.length || j < newLines.length) {
            if (
              i < oldLines.length &&
              j < newLines.length &&
              oldLines[i] === newLines[j]
            ) {
              html += renderRow(lineCounter++, " ", oldLines[i], "");
              i++;
              j++;
            } else if (
              i < oldLines.length &&
              (j >= newLines.length || !newLines.slice(j).includes(oldLines[i]))
            ) {
              html += renderRow(lineCounter++, "-", oldLines[i], "deletion");
              i++;
            } else if (j < newLines.length) {
              html += renderRow(lineCounter++, "+", newLines[j], "addition");
              j++;
            } else {
              i++;
              j++;
            }
          }
        }
        return html;
      }

      function renderRow(num, symbol, text, type) {
        return `
            <tr class="diff-line ${type}">
                <td class="line-num">${num}</td>
                <td class="line-content"><span>${symbol}</span> ${escapeHtml(text)}</td>
            </tr>`;
      }

      function generateMediaDiffHtml(oldMedia, newMedia) {
        if (!newMedia.length && !oldMedia.length) return "";

        let html =
          '<div class="media-diff"><strong>Media & Alt Text:</strong><div class="media-grid">';

        newMedia.forEach((m) => {
          const prev = oldMedia.find((p) => p.id === m.id);
          const altChanged = prev && prev.description !== m.description;

          html += `
                <div class="media-item">
                    <img src="${m.preview_url}" loading="lazy">
                    <div class="alt-text">
                        <b style="color:#79c0ff">Alt:</b> ${escapeHtml(m.description || "(Missing)")}
                        ${altChanged ? `<div class="alt-changed"><b style="color:#f0883e">Previous:</b> ${escapeHtml(prev.description || "(None)")}</div>` : ""}
                    </div>
                </div>`;
        });

        oldMedia.forEach((p) => {
          if (!newMedia.find((m) => m.id === p.id)) {
            html += `
                    <div class="media-item" style="opacity: 0.5; border: 1px solid var(--del-line)">
                        <img src="${p.preview_url}" style="filter: grayscale(1)">
                        <div class="alt-text" style="color:var(--del-line)">[Removed Attachment]</div>
                    </div>`;
          }
        });

        return html + "</div></div>";
      }

      function escapeHtml(str) {
        if (!str) return "";
        const div = document.createElement("div");
        div.textContent = str;
        return div.innerHTML;
      }
    </script>
  </body>
</html>
