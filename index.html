<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üêò</text></svg>"
    />
    <title id="pageTitle">Mastodon Edit History</title>
    <style>
      :root {
        --bg: #0d1117;
        --card-bg: #161b22;
        --text: #e6edf3;
        --border: #30363d;
        --add-bg: #2ea44f26;
        --add-line: #3fb950;
        --add-word: #238636;
        --del-bg: #da363326;
        --del-line: #f85149;
        --del-word: #da3633;
      }
      body {
        font-family: -apple-system, sans-serif;
        background: var(--bg);
        color: var(--text);
        padding: 20px;
        margin: 0;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header-ui {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
      }
      .actions {
        display: flex;
        gap: 8px;
      }
      .input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        position: sticky;
        top: 0;
        background: var(--bg);
        padding: 15px 0;
        z-index: 100;
        border-bottom: 1px solid var(--border);
      }
      input {
        flex: 1;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: var(--card-bg);
        color: white;
      }
      button {
        padding: 10px 20px;
        border-radius: 6px;
        border: none;
        background: #238636;
        color: white;
        cursor: pointer;
        font-weight: bold;
      }
      button.secondary {
        background: #30363d;
        border: 1px solid var(--border);
      }

      .revision-card {
        border: 1px solid var(--border);
        border-radius: 6px;
        margin-bottom: 40px;
        background: var(--card-bg);
        overflow: hidden;
      }
      .revision-header {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border);
        font-size: 0.9em;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #1f242c;
      }
      .ver-badge {
        background: #388bfd3d;
        color: #79c0ff;
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: bold;
        border: 1px solid #388bfd66;
      }

      .diff-wrapper {
        overflow-x: auto;
        width: 100%;
        background: #010409;
      }
      .diff-table {
        width: 100%;
        border-collapse: collapse;
        font-family: ui-monospace, SFMono-Regular, monospace;
        font-size: 13px;
      }
      .diff-line {
        display: flex;
        width: fit-content;
        min-width: 100%;
        border-left: 4px solid transparent;
      }
      .diff-line.addition {
        background-color: var(--add-bg);
        border-left-color: var(--add-line);
      }
      .diff-line.deletion {
        background-color: var(--del-bg);
        border-left-color: var(--del-line);
      }

      .line-num {
        width: 50px;
        text-align: right;
        padding-right: 15px;
        color: #484f58;
        user-select: none;
        border-right: 1px solid var(--border);
        flex-shrink: 0;
      }
      .line-content {
        padding: 10px 15px;
        white-space: pre;
        word-wrap: normal;
        flex-grow: 1;
      }

      /* Square & Borderless Highlights */
      ins {
        background-color: var(--add-word);
        text-decoration: none;
        color: #ffffff;
        padding: 2px 0;
        border-radius: 0;
        border: none;
      }
      del {
        background-color: var(--del-word);
        text-decoration: none;
        color: #ffffff;
        padding: 2px 0;
        border-radius: 0;
        border: none;
      }

      .media-diff {
        padding: 15px;
        border-top: 1px solid var(--border);
      }
      .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
      }
      .media-item {
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 8px;
        background: var(--card-bg);
        font-size: 11px;
      }
      .media-item img {
        width: 100%;
        height: 100px;
        object-fit: cover;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header-ui">
        <h2 style="margin: 0">üêò Mastodon Edit History</h2>
        <div class="actions">
          <button
            id="shareBtn"
            class="secondary"
            style="display: none"
            onclick="shareDeeplink()"
          >
            Share
          </button>
          <button
            id="copyBtn"
            class="secondary"
            style="display: none"
            onclick="copyDeepLink()"
          >
            Copy Link
          </button>
        </div>
      </div>
      <div class="input-group">
        <input
          type="text"
          id="urlInput"
          placeholder="Paste Mastodon post URL..."
        />
        <button onclick="handleCompareAction()">Compare</button>
      </div>
      <div id="output"></div>
    </div>

    <script>
      const segmenter = new Intl.Segmenter(undefined, {
        granularity: "grapheme",
      });

      window.addEventListener("DOMContentLoaded", initializeFromUrl);
      window.addEventListener("popstate", initializeFromUrl);

      function initializeFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const tootParam = params.get("toot");
        const hashParam = window.location.hash.substring(1);
        const targetUrl =
          tootParam && tootParam.startsWith("http")
            ? tootParam
            : hashParam && hashParam.startsWith("http")
              ? hashParam
              : null;

        if (targetUrl) {
          document.getElementById("urlInput").value = targetUrl;
          updatePageTitle(targetUrl);
          fetchHistory(targetUrl);
        }
      }

      function handleCompareAction() {
        const urlValue = document.getElementById("urlInput").value.trim();
        if (!urlValue) return;

        const newUrl = new URL(window.location.href);
        newUrl.searchParams.set("toot", urlValue);
        newUrl.hash = "";
        window.history.pushState({}, "", newUrl);

        updatePageTitle(urlValue);
        fetchHistory(urlValue);
      }

      function updatePageTitle(tootUrl) {
        const cleanUrl = tootUrl.replace(/^https?:\/\//, "");
        document.title = `Mastodon Edit History - ${cleanUrl}`;
      }

      function decodeAndClean(html) {
        const textOnly = html
          .replace(/<br\s*\/?>/gi, "\n")
          .replace(/<\/p><p>/gi, "\n\n")
          .replace(/<[^>]+>/g, "")
          .trim();
        const txt = document.createElement("textarea");
        txt.innerHTML = textOnly;
        return txt.value;
      }

      // Surgical Diff using LCS logic for perfect alignment
      function getSurgicalDiff(oldStr, newStr) {
        const s1 = [...segmenter.segment(oldStr)].map((s) => s.segment);
        const s2 = [...segmenter.segment(newStr)].map((s) => s.segment);
        const n = s1.length,
          m = s2.length;
        const dp = Array.from({ length: n + 1 }, () => Array(m + 1).fill(0));

        for (let i = 1; i <= n; i++) {
          for (let j = 1; j <= m; j++) {
            if (s1[i - 1] === s2[j - 1]) dp[i][j] = dp[i - 1][j - 1] + 1;
            else dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
          }
        }

        let i = n,
          j = m,
          resOld = [],
          resNew = [];
        while (i > 0 || j > 0) {
          if (i > 0 && j > 0 && s1[i - 1] === s2[j - 1]) {
            const char = escapeHtml(s1[i - 1]);
            resOld.unshift(char);
            resNew.unshift(char);
            i--;
            j--;
          } else if (j > 0 && (i === 0 || dp[i][j - 1] >= dp[i - 1][j])) {
            resNew.unshift(`<ins>${escapeHtml(s2[j - 1])}</ins>`);
            j--;
          } else if (i > 0 && (j === 0 || dp[i][j - 1] < dp[i - 1][j])) {
            resOld.unshift(`<del>${escapeHtml(s1[i - 1])}</del>`);
            i--;
          }
        }
        return { deletion: resOld.join(""), addition: resNew.join("") };
      }

      async function fetchHistory(urlInput) {
        const output = document.getElementById("output");
        output.innerHTML = "<p>Crunching history...</p>";
        document.getElementById("copyBtn").style.display = "block";
        if (navigator.share)
          document.getElementById("shareBtn").style.display = "block";

        try {
          const url = new URL(urlInput);
          const id = url.pathname.split("/").filter(Boolean).pop();
          const apiBase = `https://${url.hostname}/api/v1/statuses/${id}/history`;

          const response = await fetch(apiBase);
          if (!response.ok)
            throw new Error("Could not fetch. The post might be private.");
          const history = await response.json();
          renderHistory(history);
        } catch (e) {
          output.innerHTML = `<p style="color:var(--del-line)"><b>Error:</b> ${e.message}</p>`;
        }
      }

      function renderHistory(history) {
        const output = document.getElementById("output");
        output.innerHTML = "";

        for (let i = history.length - 1; i >= 0; i--) {
          const curr = history[i];
          const prev = i > 0 ? history[i - 1] : null;
          const card = document.createElement("div");
          card.className = "revision-card";

          const currClean = decodeAndClean(curr.content);
          const prevClean = prev ? decodeAndClean(prev.content) : "";
          const currLines = currClean.split("\n");
          const prevLines = prevClean.split("\n");

          let rowsHtml = "";
          let lineNum = 1;

          if (!prev) {
            currLines.forEach((l) => {
              rowsHtml += renderRow(lineNum++, "+", escapeHtml(l), "addition");
            });
          } else {
            let max = Math.max(currLines.length, prevLines.length);
            for (let k = 0; k < max; k++) {
              const pL = prevLines[k] || "";
              const cL = currLines[k] || "";
              if (pL === cL) {
                rowsHtml += renderRow(lineNum++, " ", escapeHtml(cL), "");
              } else {
                const diff = getSurgicalDiff(pL, cL);
                if (pL)
                  rowsHtml += renderRow(
                    lineNum,
                    "-",
                    diff.deletion,
                    "deletion",
                  );
                if (cL)
                  rowsHtml += renderRow(
                    lineNum++,
                    "+",
                    diff.addition,
                    "addition",
                  );
              }
            }
          }

          card.innerHTML = `
                <div class="revision-header">
                    <span class="ver-badge">${i === 0 ? "Original" : "Revision " + i}</span>
                    <span style="color:#8b949e">${new Date(curr.created_at).toLocaleString()}</span>
                </div>
                <div class="diff-wrapper"><table class="diff-table">${rowsHtml}</table></div>
                ${generateMediaHtml(prev ? prev.media_attachments : [], curr.media_attachments)}
            `;
          output.appendChild(card);
        }
      }

      function renderRow(num, sym, content, type) {
        return `<tr class="diff-line ${type}"><td class="line-num">${num}</td><td class="line-content"><span>${sym}</span> ${content}</td></tr>`;
      }

      function generateMediaHtml(oldM, newM) {
        if (!newM.length && !oldM.length) return "";
        let html = '<div class="media-diff"><div class="media-grid">';
        newM.forEach((m) => {
          const p = oldM.find((x) => x.id === m.id);
          const altDiff =
            p && p.description !== m.description
              ? `<div style="color:#e3b341; margin-top:4px; border-top:1px dashed #444;">Was: ${escapeHtml(p.description)}</div>`
              : "";
          html += `<div class="media-item"><img src="${m.preview_url}"><b>Alt:</b> ${escapeHtml(m.description || "None")}${altDiff}</div>`;
        });
        return html + "</div></div>";
      }

      function escapeHtml(str) {
        if (!str) return "";
        const div = document.createElement("div");
        div.textContent = str;
        return div.innerHTML;
      }

      function copyDeepLink() {
        navigator.clipboard.writeText(window.location.href);
        const btn = document.getElementById("copyBtn");
        btn.textContent = "Copied!";
        setTimeout(() => (btn.textContent = "Copy Link"), 2000);
      }

      async function shareDeeplink() {
        try {
          await navigator.share({
            title: "Mastodon Edit History",
            url: window.location.href,
          });
        } catch (err) {}
      }
    </script>
  </body>
</html>
